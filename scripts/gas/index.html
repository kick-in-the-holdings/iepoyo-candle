<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iepoyo candle 予約フォーム</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 10px 10px 0 0;
            margin: -20px -20px 0;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 -20px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #ff6b6b;
        }
        
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        /* カレンダースタイル */
        .calendar-container {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .calendar-nav:hover {
            background: #ee5a6f;
        }
        
        .calendar-nav:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .calendar-month {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 10px 0;
            font-size: 14px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .calendar-day:hover:not(.disabled):not(.selected) {
            background: #fff5f5;
            border-color: #ff6b6b;
        }
        
        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
            background: #f5f5f5;
        }
        
        .calendar-day.selected {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            font-weight: bold;
        }
        
        .calendar-day.has-slots {
            color: #ff6b6b;
            font-weight: 500;
        }
        
        /* 時間選択 */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-slot {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .time-slot:hover:not(.selected) {
            border-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .time-slot.selected {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }
        
        .time-slot.disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }
        
        /* メニュー選択 */
        .menu-grid {
            display: grid;
            gap: 10px;
        }
        
        .menu-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }
        
        .menu-item:hover:not(.selected) {
            border-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .menu-item.selected {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }
        
        .menu-item.recommended {
            position: relative;
        }
        
        .menu-item.recommended::after {
            content: 'おすすめ';
            position: absolute;
            top: -10px;
            right: 10px;
            background: #ffd700;
            color: #333;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .menu-price {
            font-weight: bold;
        }
        
        /* オプション */
        .option-grid {
            display: grid;
            gap: 10px;
        }
        
        .option-item {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }
        
        .option-item:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .option-item.selected {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }
        
        /* 送信ボタン */
        .submit-button {
            width: 100%;
            padding: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .submit-button:hover {
            background: #ee5a6f;
        }
        
        .submit-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* ローディング */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* エラーメッセージ */
        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* 成功メッセージ */
        .success-message {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .success-message.show {
            display: block !important;
        }
        
        .success-message h3 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .success-message p {
            margin-bottom: 15px;
            line-height: 1.8;
            color: #666;
        }
        
        .success-message .booking-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
            text-align: left;
            border: 2px solid #ff6b6b;
            position: relative;
        }
        
        .success-message .booking-info::before {
            content: '📋';
            position: absolute;
            top: -15px;
            left: 20px;
            background: white;
            padding: 0 10px;
            font-size: 24px;
        }
        
        .success-message .booking-info h4 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .success-message .booking-info p {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .email-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0;
            position: relative;
            text-align: left;
        }
        
        .email-warning::before {
            content: '⚠️';
            position: absolute;
            top: -15px;
            left: 20px;
            background: white;
            padding: 0 10px;
            font-size: 24px;
        }
        
        .email-warning h5 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .email-warning p {
            margin: 5px 0;
            color: #856404;
            font-size: 15px;
        }
        
        .email-warning .email-address {
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .social-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .social-section h4 {
            color: #ff6b6b;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .social-link {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            background: white;
            border-radius: 50px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .social-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .social-link.line {
            background: #00B900;
            color: white;
        }
        
        .social-link.instagram {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            color: white;
        }
        
        .social-link.homepage {
            background: #ff6b6b;
            color: white;
        }
        
        .social-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
        
        .final-message {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid #ffcccc;
        }
        
        .final-message p {
            color: #666;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .success-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        
        @media (max-width: 768px) {
            .social-links {
                flex-direction: column;
                align-items: center;
            }
            
            .social-link {
                width: 80%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>iepoyo candle 予約フォーム</h1>
            <p>手作りキャンドル体験のご予約</p>
        </div>
        
        <div class="form-container">
            <form id="bookingForm">
                <!-- 連絡先情報 -->
                <div class="section">
                    <h2 class="section-title">連絡先情報</h2>
                    
                    <div class="form-group">
                        <label for="name">代表者氏名 <span style="color: red;">*</span></label>
                        <input type="text" id="name" name="name" required>
                        <div class="help-text">ご予約代表者のお名前をフルネームでご記入ください</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">メールアドレス <span style="color: red;">*</span></label>
                        <input type="email" id="email" name="email" required>
                        <div class="help-text">予約確認メールをお送りします</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">電話番号 <span style="color: red;">*</span></label>
                        <input type="tel" id="phone" name="phone" pattern="[0-9]{10,11}" required>
                        <div class="help-text">ハイフンなしで入力してください（例：09012345678）</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="participants">参加人数 <span style="color: red;">*</span></label>
                        <input type="number" id="participants" name="participants" min="1" max="10" required>
                        <div class="help-text">体験される人数を入力してください</div>
                    </div>
                </div>
                
                <!-- 日時選択 -->
                <div class="section">
                    <h2 class="section-title">ご希望の日時</h2>
                    
                    <div class="form-group">
                        <label>日付を選択 <span style="color: red;">*</span></label>
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button type="button" class="calendar-nav" id="prevMonth">&lt;</button>
                                <div class="calendar-month" id="currentMonth">2024年12月</div>
                                <button type="button" class="calendar-nav" id="nextMonth">&gt;</button>
                            </div>
                            <div class="calendar-grid" id="calendar">
                                <!-- カレンダーはJavaScriptで生成 -->
                            </div>
                        </div>
                        <input type="hidden" id="selectedDate" name="selectedDate" required>
                    </div>
                    
                    <div class="form-group" id="timeSlotGroup" style="display: none;">
                        <label>時間帯を選択 <span style="color: red;">*</span></label>
                        <div class="time-slots" id="timeSlots">
                            <!-- 時間帯はJavaScriptで生成 -->
                        </div>
                        <input type="hidden" id="selectedTime" name="selectedTime" required>
                    </div>
                </div>
                
                <!-- メニュー選択 -->
                <div class="section">
                    <h2 class="section-title">メニュー選択</h2>
                    
                    <div class="form-group">
                        <label>体験メニュー <span style="color: red;">*</span></label>
                        <div class="menu-grid" id="menuItems">
                            <!-- メニューはJavaScriptで生成 -->
                        </div>
                        <input type="hidden" id="selectedMenu" name="selectedMenu" required>
                    </div>
                    
                    <div class="form-group">
                        <label>オプション（複数選択可）</label>
                        <div class="option-grid" id="optionItems">
                            <!-- オプションはJavaScriptで生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 備考 -->
                <div class="section">
                    <h2 class="section-title">その他</h2>
                    
                    <div class="form-group">
                        <label for="remarks">備考・ご要望</label>
                        <textarea id="remarks" name="remarks" rows="4"></textarea>
                        <div class="help-text">その他ご要望などがございましたらご記入ください</div>
                    </div>
                </div>
                
                <!-- 送信ボタン -->
                <button type="submit" class="submit-button" id="submitButton">予約を確定する</button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>予約を処理しています...</p>
                </div>
                
                <div class="success-message" id="successMessage">
                    <div class="success-icon">✅</div>
                    <h3>🎉 ご予約ありがとうございます！</h3>
                    <p style="font-size: 18px; color: #333;">
                        iepoyo candleでのキャンドル作り体験のご予約を<br>
                        確かに承りました。
                    </p>
                    
                    <div class="booking-info" id="bookingConfirmation">
                        <h4>ご予約内容</h4>
                        <p id="confirmDate">日時: </p>
                        <p id="confirmName">お名前: </p>
                        <p id="confirmParticipants">参加人数: </p>
                        <p id="confirmMenu">メニュー: </p>
                        <p id="confirmTotal" style="font-size: 18px; font-weight: bold; color: #ff6b6b;">合計金額: </p>
                    </div>
                    
                    <div class="email-warning">
                        <h5>📧 確認メールについて重要なお知らせ</h5>
                        <p>予約確認メールを送信しました。</p>
                        <p><strong>必ずご確認ください：</strong></p>
                        <p>✉️ メールが届かない場合は<strong>迷惑メールフォルダ</strong>をご確認ください</p>
                        <p>🗑️ <strong>ゴミ箱</strong>に振り分けられることもあります</p>
                        <p>📌 今後のために <span class="email-address">iepoyocandle@gmail.com</span> を連絡先に追加してください</p>
                    </div>
                    
                    <div class="social-section">
                        <h4>🕯️ iepoyo candleをもっと知る</h4>
                        <p style="margin-bottom: 20px;">
                            最新情報やキャンドル作品をチェック！<br>
                            ぜひフォローしてください♪
                        </p>
                        
                        <div class="social-links">
                            <a href="https://lin.ee/k0N5obP" 
                               class="social-link line" 
                               target="_blank">
                                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.84 14.32C16.84 14.32 15.54 15.68 15.29 15.95C15.02 16.25 14.71 16.25 14.38 16.02C13.72 15.56 13.06 15.02 12.46 14.42C11.86 13.82 11.32 13.16 10.86 12.5C10.63 12.17 10.63 11.86 10.93 11.59C11.2 11.32 11.48 11.05 11.75 10.78C11.84 10.69 11.84 10.6 11.75 10.51L10.46 8.64C10.37 8.46 10.28 8.46 10.1 8.55C9.56 8.91 9.02 9.35 8.57 9.8C8.3 10.07 8.3 10.43 8.48 10.79C9.38 12.68 10.64 14.3 12.35 15.56C12.71 15.83 13.07 15.83 13.43 15.56C13.88 15.11 14.32 14.57 14.68 14.03C14.77 13.94 14.77 13.85 14.68 13.76L12.81 12.47C12.72 12.38 12.63 12.38 12.54 12.47C12.27 12.74 12 13.01 11.73 13.28C11.64 13.37 11.55 13.37 11.46 13.28C11.1 12.92 10.74 12.56 10.38 12.2C10.29 12.11 10.29 12.02 10.38 11.93C10.65 11.66 10.92 11.39 11.19 11.12C11.28 11.03 11.28 10.94 11.19 10.85L9.9 9.56C9.81 9.47 9.72 9.47 9.63 9.56C9.09 10.1 8.55 10.73 8.1 11.36C7.65 11.99 7.65 12.71 8.1 13.34C8.91 14.51 9.9 15.5 11.07 16.31C11.7 16.76 12.42 16.76 13.05 16.31C13.68 15.86 14.31 15.32 14.85 14.78C14.94 14.69 14.94 14.6 14.85 14.51L13.56 13.22C13.47 13.13 13.38 13.13 13.29 13.22C13.02 13.49 12.75 13.76 12.48 14.03C12.39 14.12 12.3 14.12 12.21 14.03C11.85 13.67 11.49 13.31 11.13 12.95C11.04 12.86 11.04 12.77 11.13 12.68C11.4 12.41 11.67 12.14 11.94 11.87C12.03 11.78 12.03 11.69 11.94 11.6L10.65 10.31C10.56 10.22 10.47 10.22 10.38 10.31C9.84 10.85 9.3 11.48 8.85 12.11C8.58 12.47 8.58 12.92 8.85 13.28L10.14 14.57C10.23 14.66 10.32 14.66 10.41 14.57C10.68 14.3 10.95 14.03 11.22 13.76C11.31 13.67 11.4 13.67 11.49 13.76C11.85 14.12 12.21 14.48 12.57 14.84C12.66 14.93 12.66 15.02 12.57 15.11C12.3 15.38 12.03 15.65 11.76 15.92C11.67 16.01 11.58 16.01 11.49 15.92L10.2 14.63C10.11 14.54 10.02 14.54 9.93 14.63C9.39 15.17 8.85 15.8 8.4 16.43C8.13 16.79 8.13 17.24 8.4 17.6C8.76 17.96 9.12 18.32 9.48 18.68C9.84 19.04 10.29 19.04 10.65 18.68C11.28 18.05 11.91 17.42 12.45 16.7C12.54 16.61 12.63 16.61 12.72 16.7L14.59 18.57C14.68 18.66 14.77 18.66 14.86 18.57C15.4 18.03 15.94 17.4 16.39 16.77C16.66 16.41 16.66 15.96 16.39 15.6L15.1 14.31C15.01 14.22 14.92 14.22 14.83 14.31C14.83 14.31 16.84 14.32 16.84 14.32Z"/>
                                </svg>
                                LINE公式アカウント
                            </a>
                            
                            <a href="https://www.instagram.com/iepoyo.miyako/" 
                               class="social-link instagram" 
                               target="_blank">
                                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.405a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"/>
                                </svg>
                                Instagram
                            </a>
                            
                            <a href="https://kick-in-the-holdings.github.io/iepoyo-candle/" 
                               class="social-link homepage" 
                               target="_blank">
                                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                </svg>
                                公式ホームページ
                            </a>
                        </div>
                    </div>
                    
                    <div class="final-message">
                        <p>🕯️ <strong>当日のご案内</strong></p>
                        <p>・開始時刻の5分前までにお越しください</p>
                        <p>・エプロンは無料で貸し出しいたします</p>
                        <p>・作品は当日お持ち帰りいただけます</p>
                        <p>・お支払いは現地にて現金でお願いいたします</p>
                        <br>
                        <p style="font-size: 18px; text-align: center;">
                            <strong>素敵なキャンドル作りの時間を<br>
                            一緒に楽しみましょう！✨</strong>
                        </p>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // グローバル変数
        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let selectedMenu = null;
        let selectedOptions = [];
        let availableDates = {};
        
        // メニュー情報
        const MENU_ITEMS = [
            { name: 'マーブルキャンドル', price: 2500 },
            { name: '貝殻キャンドル', price: 3000 },
            { name: '球体キャンドル', price: 3500, recommended: true },
            { name: '球体キャンドル(Big)', price: 5000 }
        ];
        
        const OPTION_ITEMS = [
            { name: 'ラメ', price: 500 },
            { name: '金箔', price: 500 },
            { name: 'エッセンシャルオイル', price: 500 }
        ];
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalendar();
            initializeMenus();
            setupEventListeners();
            loadAvailableDates();
            
            // iframe内で実行されている場合、高さ情報を親に送信
            if (window.parent !== window) {
                sendHeightToParent();
                // 内容が変わったときに高さを再送信
                const observer = new MutationObserver(sendHeightToParent);
                observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                    attributes: true
                });
            }
        });
        
        // 親ウィンドウに高さを送信
        function sendHeightToParent() {
            if (window.parent !== window) {
                const height = document.body.scrollHeight;
                window.parent.postMessage({
                    type: 'resize',
                    height: height
                }, '*');
            }
        }
        
        // カレンダーの初期化
        function initializeCalendar() {
            renderCalendar();
        }
        
        // カレンダーのレンダリング
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 月の表示を更新
            document.getElementById('currentMonth').textContent = 
                `${year}年${month + 1}月`;
            
            // カレンダーグリッドをクリア
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            // 曜日ヘッダー
            const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // 月の最初の日と最後の日を取得
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 最初の週の空白
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                calendar.appendChild(emptyDay);
            }
            
            // 日付を生成
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dateObj = new Date(year, month, day);
                const dateStr = formatDateForKey(dateObj);
                
                // 過去の日付は無効化
                if (dateObj < today) {
                    dayElement.classList.add('disabled');
                } else if (availableDates[dateStr]) {
                    dayElement.classList.add('has-slots');
                    dayElement.onclick = () => selectDate(dateObj);
                } else {
                    dayElement.onclick = () => selectDate(dateObj);
                }
                
                // 選択された日付をハイライト
                if (selectedDate && 
                    selectedDate.getDate() === day && 
                    selectedDate.getMonth() === month && 
                    selectedDate.getFullYear() === year) {
                    dayElement.classList.add('selected');
                }
                
                calendar.appendChild(dayElement);
            }
        }
        
        // 日付選択
        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
            
            document.getElementById('selectedDate').value = formatDateForKey(date);
            
            // 時間帯を読み込み
            loadTimeSlots(date);
        }
        
        // 時間帯の読み込み
        function loadTimeSlots(date) {
            const timeSlotGroup = document.getElementById('timeSlotGroup');
            const timeSlotsContainer = document.getElementById('timeSlots');
            
            timeSlotGroup.style.display = 'block';
            timeSlotsContainer.innerHTML = '<p>読み込み中...</p>';
            
            // サーバーから利用可能な時間帯を取得
            google.script.run
                .withSuccessHandler(function(slots) {
                    renderTimeSlots(slots);
                })
                .withFailureHandler(function(error) {
                    timeSlotsContainer.innerHTML = '<p style="color: red;">エラーが発生しました</p>';
                })
                .getAvailableTimeSlotsForDateAjax(formatDateForKey(date));
        }
        
        // 時間帯のレンダリング
        function renderTimeSlots(slots) {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            if (slots.length === 0) {
                container.innerHTML = '<p>この日は予約できる時間帯がありません</p>';
                return;
            }
            
            slots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.textContent = slot;
                slotElement.onclick = () => selectTimeSlot(slot, slotElement);
                container.appendChild(slotElement);
            });
        }
        
        // 時間帯選択
        function selectTimeSlot(time, element) {
            // 以前の選択をクリア
            document.querySelectorAll('.time-slot').forEach(el => {
                el.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedTime = time;
            document.getElementById('selectedTime').value = time;
        }
        
        // メニューの初期化
        function initializeMenus() {
            // メインメニュー
            const menuContainer = document.getElementById('menuItems');
            MENU_ITEMS.forEach(item => {
                const menuElement = document.createElement('div');
                menuElement.className = 'menu-item';
                if (item.recommended) {
                    menuElement.classList.add('recommended');
                }
                menuElement.innerHTML = `
                    <span>${item.name}</span>
                    <span class="menu-price">¥${item.price.toLocaleString()}</span>
                `;
                menuElement.onclick = () => selectMenu(item, menuElement);
                menuContainer.appendChild(menuElement);
            });
            
            // オプション
            const optionContainer = document.getElementById('optionItems');
            OPTION_ITEMS.forEach(item => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option-item';
                optionElement.innerHTML = `
                    <span>${item.name}</span>
                    <span>¥${item.price}</span>
                `;
                optionElement.onclick = () => toggleOption(item, optionElement);
                optionContainer.appendChild(optionElement);
            });
        }
        
        // メニュー選択
        function selectMenu(menu, element) {
            document.querySelectorAll('.menu-item').forEach(el => {
                el.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedMenu = menu;
            document.getElementById('selectedMenu').value = 
                `${menu.name}：${menu.price}円`;
        }
        
        // オプション選択
        function toggleOption(option, element) {
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedOptions = selectedOptions.filter(o => o.name !== option.name);
            } else {
                element.classList.add('selected');
                selectedOptions.push(option);
            }
        }
        
        // イベントリスナーの設定
        function setupEventListeners() {
            // カレンダーナビゲーション
            document.getElementById('prevMonth').onclick = () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            };
            
            document.getElementById('nextMonth').onclick = () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            };
            
            // フォーム送信
            document.getElementById('bookingForm').onsubmit = (e) => {
                e.preventDefault();
                submitForm();
            };
        }
        
        // 利用可能な日付を読み込み
        function loadAvailableDates() {
            google.script.run
                .withSuccessHandler(function(dates) {
                    dates.forEach(date => {
                        availableDates[date.value] = true;
                    });
                    renderCalendar();
                })
                .withFailureHandler(function(error) {
                    console.error('日付の読み込みに失敗しました:', error);
                })
                .getAvailableDates();
        }
        
        // フォーム送信
        function submitForm() {
            console.log('submitForm開始');
            
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                participants: document.getElementById('participants').value,
                date: formatDateForDisplay(selectedDate),
                time: selectedTime,
                menu: selectedMenu,
                options: selectedOptions,
                remarks: document.getElementById('remarks').value
            };
            
            console.log('送信データ:', formData);
            
            // ローディング表示
            document.getElementById('submitButton').disabled = true;
            document.getElementById('loading').classList.add('show');
            
            // サーバーに送信
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('予約成功:', result);
                    
                    // 合計金額を計算
                    const menuPrice = formData.menu.price;
                    const participantCount = parseInt(formData.participants);
                    const optionCount = formData.options.length;
                    const totalPrice = (menuPrice * participantCount) + 
                                     (optionCount * 500 * participantCount);
                    
                    // 予約情報をまとめる
                    const bookingInfo = {
                        date: formData.date,
                        time: formData.time,
                        name: formData.name,
                        participants: formData.participants,
                        menu: formData.menu.name,
                        total: totalPrice.toLocaleString()
                    };
                    
                    // iframe内から親ウィンドウにメッセージを送信
                    if (window.parent !== window) {
                        console.log('親ウィンドウにメッセージを送信');
                        window.parent.postMessage({
                            type: 'bookingComplete',
                            bookingInfo: bookingInfo
                        }, '*');
                    } else {
                        // 直接アクセスの場合は、成功メッセージを表示
                        document.getElementById('loading').classList.remove('show');
                        document.getElementById('bookingForm').style.display = 'none';
                        
                        // 予約内容を表示
                        document.getElementById('confirmDate').textContent = 
                            `日時: ${formData.date} ${formData.time}`;
                        document.getElementById('confirmName').textContent = 
                            `お名前: ${formData.name}様`;
                        document.getElementById('confirmParticipants').textContent = 
                            `参加人数: ${formData.participants}名`;
                        document.getElementById('confirmMenu').textContent = 
                            `メニュー: ${formData.menu.name}`;
                        document.getElementById('confirmTotal').textContent = 
                            `合計金額: ¥${totalPrice.toLocaleString()}`;
                        
                        // 成功メッセージを表示
                        document.getElementById('successMessage').classList.add('show');
                        document.getElementById('successMessage').style.display = 'block';
                        
                        // ページトップへスクロール
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('予約エラー:', error);
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('submitButton').disabled = false;
                    alert('予約の送信に失敗しました。もう一度お試しください。\nエラー: ' + error);
                })
                .processBooking(formData);
        }
        
        // 日付フォーマット（キー用）
        function formatDateForKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 日付フォーマット（表示用）
        function formatDateForDisplay(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
            return `${year}年${month}月${day}日（${dayOfWeek}）`;
        }
    </script>
</body>
</html>